# Conflict Resolution

The conflict resolution could help into resolving a conflict generated by a consumer during a data exchange or after being invoiced for it.

Conflict Resolution relies on two subsystems:

 1. [The non-repudiation-protocol library](https://gitlab.com/i3-market/code/wp3/t3.2/conflict-resolution/non-repudiation-protocol); and
 2. [The conflict-resolver service](https://gitlab.com/i3-market/code/wp3/t3.2/conflict-resolution/conflict-resolver).

For the Conflict-Resolver Service (CRS) to solve a dispute, the non-repudiation protocol library must be used during the data exchange, since it will help create the necessary non-repudiation proofs of the exchange.

## Use cases

The Conflict Resolution will prevent the following situations affecting a-posteriori payments, where consumers are not paying after receiving data, likely because they argue that they have not received them. Based on the non-repudiation proofs exchanged during the data exchange, the Conflict-Resolver service can univocally determine if the consumers has to pay (data was available) or not (the provider didn't send the data, or didn't send them under the agreed terms)

For it to happen, every block of data must exchanged using the non-repudiation protocol. Accounted proofs give no room to alter the invoicing (fiat money) or the crypto payments (i3-MARKET tokens) if both entities reliably execute the protocol; otherwise the Conflict Resolver service can be invoked to univocally solve which entity is intentionally or unintentionally malfunctioning.

The non repudiation protocol starts with a Provider Alice, hereby A, sending a signed Proof of Origin (PoO) along with an encrypted block of data to a Consumer Bob, hereby B.

After validating the PoO, B will demonstrate his will to get the data by sending a signed Proof of Reception (PoR). Just recall that B is at this point not yet able to decrypt the data, since he does not know the secret to decrypt them.

The PoR is a proof that can be used by A to demonstrate that B is commited to get the secret to decrypt the block of data.

Now A can release the secret as part of a Proof of Publication (PoP). However, as B may state that he did not receive the PoP, A also publishes the secret to the ledger. It is now under B's responsibility to get the secret from the ledger, since he implicitly agreed to it when sending the PoR.

For A to create a valid invoice for that block of data, she MUST present a valid PoR and demonstrate that the secret was published to the ledger within the agreed delay (part of the agreement).

As a result, an invalid invoice will lack one of the previous. Obviously, it could also happen that the published secret does not

The Conflict-Resolver Service (CSR) can be queried to provide a signed resolution about the non-repudiation protocol associated to an invoice being valid or invalid. It could be invoked by either the consumer or the provider. The latter should be mandatory, being the resolution sent along with the invoice to the consumer.

However, this resolution does not ensure that the published secret could be used to decrypt the encrypted block of data. If the consumer B is not able to decrypt the cipherblock, he could initiate a dispute on the CRS. The CRS will also provide signed resolution of whether B is right or not.

## Endpoints

The Conflict-Resolver Service provides two endpoints: one for checking that the protocol was executed properly, and other one to initiate a dispute when a Consumer B claims that he cannot decrypt the cipherblock he has been invoiced for.

### ```POST /verification```

Authenticated endpoint that can only be accessed by i3-MARKET Consumers.

#### Input

A valid PoR or PoP as a compact JSON Web Signature (JWS) should be POSTed to this endpoint. Either proof is enough to verify the data exchange and check if the secret was published to the ledger.

```typescript
{
  por?: string // a the PoR in compact JWS format
  pop?: string // a the PoP in compact JWS format
}
```

#### Output

It returns a signed resolution as a compact JWS with payload:

```typescript
{
  dataExchangeId: string // the unique id of this data exchange
  exchangeVerified: boolean // whether the completion of the data exchange has been verified
  iat: nume // unix timestamp stating when it was verified
  iss: string // the public key of the CRS in JWK
}
```

### ```POST /dispute```

Authenticated endpoint that can only be accessed by i3-MARKET Consumers.

#### Input

```typescript
{
  por?: string // a the PoR in compact JWS format
  pop?: string // a the PoP in compact JWS format
  cipherblock: string // the cipherblock as a JWE string
}
```

#### Output

It returns a signed resolution as a compact JWS with payload:

```typescript
{
  dataExchangeId: string // the unique id of this data exchange
  badDecryption: boolean // whether the cipherblock could be decrypted or not
  iat: nume // unix timestamp stating when it was verified
  iss: string // the public key of the CRS in JWK
}
```
